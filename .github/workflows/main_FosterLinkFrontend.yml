name: Build and deploy Vite React app to Azure Web App

on:
  push:
    branches: 
      - master
      - staging
  workflow_dispatch:

env:
  # These should come from GitHub's Action Variables or Secretsâ€”not from env.* inside env
  VITE_API_URL: ${{ github.ref_name == 'staging' && vars.VITE_API_URL_STAGING || vars.VITE_API_URL_PROD }}
  VITE_GRAFANA_FARO_URL: ${{ github.ref_name == 'staging' && vars.GRAFANA_FARO_URL_STAGING || vars.GRAFANA_FARO_URL_PROD }}
  VITE_BRANCH: ${{ github.ref_name }}
  VITE_MAPS_API_KEY: ${{ secrets.MAPS_API_KEY }}
  VITE_AZURE_BACKEND_PROD: ${{ vars.AZURE_BACKEND_PROD }}
  VITE_AZURE_BACKEND_STAGING: ${{ vars.AZURE_BACKEND_STAGING }}
  VITE_AZURE_FRONTEND_PROD: ${{ vars.AZURE_FRONTEND_PROD }}
  VITE_AZURE_FRONTEND_STAGING: ${{ vars.AZURE_FRONTEND_STAGING }}
  VITE_AZURE_DB_PROD: ${{ vars.AZURE_DB_PROD }}
  VITE_AZURE_DB_STAGING: ${{ vars.AZURE_DB_STAGING }}
  VITE_GRAF_DB_FRONTEND_STAGING: ${{ vars.GRAF_DB_FRONTEND_STAGING }}
  VITE_GRAF_DB_FRONTEND_PROD: ${{ vars.GRAF_DB_FRONTEND_PROD }}
  VITE_ALLOY: ${{ vars.ALLOY }}
  VITE_GRAF_DB_BACKEND: ${{ vars.GRAF_DB_BACKEND }}


jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'

      - name: Install dependencies
        run: npm ci

      - name: "Print API url"
        run: echo "API URL - '${{ github.ref_name == 'staging' && vars.VITE_API_URL_STAGING || vars.VITE_API_URL_PROD }}'"

      - name: Build project
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.ref_name }}

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: .
      
      - name: List environment info
        run: echo "Github branch ${{ github.ref_name }} | Azure profile name ${{ vars.ENV_NAME }}"

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ vars.ENV_NAME }}
          slot-name: Production
          publish-profile: ${{ secrets.PUBLISH_PROFILE }}
          package: .